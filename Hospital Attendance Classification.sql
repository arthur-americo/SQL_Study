'This SQL script classifies hospital attendances based on unit and bed codes. It retrieves information about the attendance, 
patient, attendance origin, discharge reason, bed, unit, sector, and surgery notices. The script filters the data by 
discharge date, attendance type, and multi-company code. The classification is done using a CASE statement that checks the 
unit and bed codes and assigns a classification of ‘DISCARDED’, ‘OBSTETRIC’, or ‘ERROR’. The script also calculates the 
number of elective and realized surgeries for each attendance. The results are ordered by multi-company code and attendance 
code.'
SELECT
    A.COMPANY_CODE,
    A.ATTENDANCE_CODE,
    A.ATTENDANCE_TYPE,
    TO_CHAR(A.ATTENDANCE_DATE,'YYYY-MM-DD') AS ATTENDANCE_DATE,
    TO_CHAR(A.DISCHARGE_DATE,'YYYY-MM-DD') AS DISCHARGE_DATE,
    MA.DISCHARGE_REASON_TYPE,
    A.DISCHARGE_REASON_CODE,
    OA.ATTENDANCE_ORIGIN_CODE,
    OA.ATTENDANCE_ORIGIN_DESCRIPTION,
    P.PATIENT_CODE,
    P.PATIENT_NAME,
    TO_CHAR(P.BIRTH_DATE,'YYYY-MM-DD') AS BIRTH_DATE,
    S.SECTOR_CODE,
    S.SECTOR_NAME,
    U.UNIT_CODE,
    U.UNIT_DESCRIPTION,
    L.BED_CODE,
    L.BED_DESCRIPTION,
    NVL(AC.ELECTIVE_COUNTER,0) AS ELECTIVE_COUNTER,
    NVL(AC.REALIZED_COUNTER,0) AS REALIZED_COUNTER,
    TRUNC(DISCHARGE_DATE-ATTENDANCE_DATE) AS OVERNIGHT_COUNT,
    CASE
        /*MEDICAL CLINIC*/
        WHEN U.UNIT_CODE IN (
                67,70,72,153,154,373,374,170,171,172,173,174,175,179,183,253,256,257,258,337,356,357,367,368,407,411,412,413,
                200,201,202,204,205,206,207,208,209,210,265,313,314,315,322,323,325,327,329,330,332,334,355,369,370,388,395,401,403,428,429,462)
                AND ((TRUNC(DISCHARGE_DATE-ATTENDANCE_DATE) > 0) OR (MA.DISCHARGE_REASON_TYPE = 'O'))
            THEN 'MEDICAL CLINIC'
        WHEN U.UNIT_CODE IN (
                67,70,72,153,154,373,374,170,171,172,173,174,175,179,183,253,256,257,258,337,356,357,367,368,407,411,412,413,
                200,201,202,204,205,206,207,208,209,210,265,313,314,315,322,323,325,327,329,330,332,334,355,369,370,388,395,401,403,428,429,462)
                AND (TRUNC(DISCHARGE_DATE-ATTENDANCE_DATE) = 0) AND (MA.DISCHARGE_REASON_TYPE <> 'O')
            THEN 'DISCARDED'
        WHEN U.UNIT_CODE IN (68,69,196,359,414,18,321,326,347,377,463,490)
                AND (NVL(AC.REALIZED_COUNTER,0) = 0)
               /*MEDICAL CLINIC*/
        WHEN U.UNIT_CODE IN (68,69,196,359,414,18,321,326,347,377,463,490)
                AND (NVL(AC.REALIZED_COUNTER,0) = 0)
                AND (TRUNC(DISCHARGE_DATE-ATTENDANCE_DATE) = 0)
                AND (MA.DISCHARGE_REASON_TYPE <> 'O')
            THEN 'DISCARDED'
        /* SURGICAL EMERGENCY AND ELECTIVE SURGERY */
        WHEN (U.UNIT_CODE IN (68,69,196,359,414,18,321,326,347,377,463,490) AND (NVL(AC.ELECTIVE_COUNTER,0) = 0) AND (NVL(AC.REALIZED_COUNTER,0) > 0)) THEN 'SURGICAL EMERGENCY'
        WHEN (U.UNIT_CODE IN (68,69,196,359,414,18,321,326,347,377,463,490) AND (NVL(AC.ELECTIVE_COUNTER,0) > 0)) THEN 'ELECTIVE SURGERY'
        /* PEDIATRIC */
        WHEN U.UNIT_CODE IN (324,382,389,402,421,422) THEN 'PEDIATRIC'
        /* ONCOLOGICAL AND ONCOLOGICAL SURGERY */
        WHEN (U.UNIT_CODE IN (458) AND (NVL(AC.REALIZED_COUNTER,0) = 0)) THEN 'ONCOLOGICAL'
        WHEN (U.UNIT_CODE IN (458) AND (NVL(AC.REALIZED_COUNTER,0) > 0)) THEN 'ONCOLOGICAL SURGERY'
        /* MENTAL HEALTH */
        WHEN U.UNIT_CODE IN (348) THEN 'MENTAL HEALTH'
        /* DAY BED */
        WHEN U.UNIT_CODE IN (427,358,392) THEN 'DAY BED'
        /* OBSTETRIC */
        WHEN U.UNIT_CODE IN (177) AND
            L.BED_CODE NOT IN (7105,7106,7107,7108,7109,7110,7111,7112,7113,7114,7115,7116,8376,8377,8378,8379,8380,8381,8382,8383,8384,8385,8386,8394,8395,8396,8423,8696)
            THEN 'OBSTETRIC'
        WHEN U.UNIT_CODE IN (177) AND
            L.BED_CODE IN (7105,7106,7107,7108,7109,7110,7111,7112,7113,7114,7115,7116,8376,8377,8378,8379,8380,8381,8382,8383,8384,8385,8386,8394,8395,8396,8423,8696)
            THEN 'DISCARDED'
        WHEN U.UNIT_CODE IN (184) AND
            L.BED_CODE NOT IN (1647,7117,7118,7119,8387,8388,8389,8685)
            THEN 'OBSTETRIC'
                WHEN U.UNIT_CODE IN (184) AND
            L.BED_CODE IN (1647,7117,7118,7119,8387,8388,8389,8685)
            THEN 'DISCARDED'
        WHEN U.UNIT_CODE IN (420) AND
            L.BED_CODE NOT IN (9679,9681,9683,9685,9687,9689,9691,9693,9695,9697,9699,9701,9703,9705,9707,9709,9711,9713,9715,9717,
                9719,9721,9723,9725,9727,9728,9730,9731,9733,9734,9736,9737,9739,9740,9742,9743,9744)
            THEN 'OBSTETRIC'
        WHEN U.UNIT_CODE IN (420) AND
            L.BED_CODE IN (9679,9681,9683,9685,9687,9689,9691,9693,9695,9697,9699,9701,9703,9705,9707,9709,9711,9713,9715,9717,
                9719,9721,9723,9725,9727,9728,9730,9731,9733,9734,9736,9737,9739,9740,9742,9743,9744)
            THEN 'DISCARDED'
        WHEN U.UNIT_CODE IN (220,423,424,426) THEN 'OBSTETRIC'
        WHEN U.UNIT_CODE IN (150) THEN 'DISCARDED'
        /* ERROR */
        ELSE 'ERROR'
        END AS CLASSIFICATION
FROM DBAMV.ATTENDANCE A
INNER JOIN DBAMV.PATIENT P
ON A.PATIENT_CODE = P.PATIENT_CODE
LEFT JOIN DBAMV.ATTENDANCE_ORIGIN OA
ON A.ATTENDANCE_ORIGIN_CODE = OA.ATTENDANCE_ORIGIN_CODE
LEFT JOIN DBAMV.DISCHARGE_REASON MA
ON A.DISCHARGE_REASON_CODE = MA.DISCHARGE_REASON_CODE
LEFT JOIN DBAMV.BED L
ON A.BED_CODE = L.BED_CODE
LEFT JOIN DBAMV.UNIT U
ON L.UNIT_CODE = U.UNIT_CODE
LEFT JOIN SECTOR S
ON U.SECTOR_CODE = S.SECTOR_CODE
LEFT JOIN (
    SELECT
        X.ATTENDANCE_CODE,
        SUM(CASE WHEN (X.SURGERY_TYPE = 'E' AND X.REALIZATION_DATE IS NOT NULL) THEN 1 ELSE 0 END) AS ELECTIVE_COUNTER,
        SUM(CASE WHEN (X.REALIZATION_DATE IS NOT NULL) THEN 1 ELSE 0 END) AS REALIZED_COUNTER
    FROM DBAMV.SURGERY_NOTICE X
    WHERE X.MULTI_COMPANY_CODE IN (16,21,26)
    AND X.ATTENDANCE_CODE IN (
        SELECT
        Y.ATTENDANCE_CODE
        FROM DBAMV.ATTENDANCE Y
        WHERE TRUNC(Y.DISCHARGE_DATE) = TO_DATE($IAString01$,'YYYY-MM-DD') 
    )
    GROUP BY X.ATTENDANCE_CODE
) AC
ON A.ATTENDANCE_CODE = AC.ATTENDANCE_CODE
WHERE TRUNC(A.DISCHARGE_DATE) = TO_DATE($IAString01$,'YYYY-MM-DD')
AND A.ATTENDANCE_TYPE = 'I'
AND A.MULTI_COMPANY_CODE IN (16,21,26)
ORDER BY
    MULTI_COMPANY_CODE,
    ATTENDANCE_CODE